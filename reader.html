<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <title>อ่านนิยายฟรี</title>
  <style>
    body { background:#000;color:#fff;margin:0;font-family:sans-serif;}
    #controls { padding:10px; background:#111; position:sticky; top:0; }
    button { margin-right:10px; }
    #pdf-canvas { display:block; margin:0 auto; }
  </style>
</head>
<body>

<div id="controls">
  <button onclick="prevPage()">⬅ หน้า</button>
  <button onclick="nextPage()">หน้า ➡</button>
  <button onclick="toggleDark()">Dark/Light</button>
  <button onclick="zoomIn()">ซูม +</button>
  <button onclick="zoomOut()">ซูม -</button>
  <span>หน้า <span id="page-num"></span> / <span id="page-count"></span></span>
</div>

<canvas id="pdf-canvas"></canvas>

<script src="pdfjs/pdf.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';

const urlParams = new URLSearchParams(window.location.search);
const pdfUrl = urlParams.get('url');
const title = urlParams.get('title') || 'PDF';
document.title = title;

let pdfDoc = null,
    pageNum = parseInt(localStorage.getItem(pdfUrl) || 1),
    pageRendering = false,
    pageNumPending = null,
    scale = 1.2,
    canvas = document.getElementById('pdf-canvas'),
    ctx = canvas.getContext('2d');

function renderPage(num) {
  pageRendering = true;
  pdfDoc.getPage(num).then(function(page) {
    let viewport = page.getViewport({scale: scale});
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    page.render({canvasContext: ctx, viewport: viewport}).promise.then(function () {
      pageRendering = false;
      if (pageNumPending !== null) {
        renderPage(pageNumPending);
        pageNumPending = null;
      }
    });
    document.getElementById('page-num').textContent = num;
    localStorage.setItem(pdfUrl, num);  // save last page
  });
}

function queueRenderPage(num) {
  if (pageRendering) {
    pageNumPending = num;
  } else {
    renderPage(num);
  }
}

function prevPage() {
  if (pageNum <= 1) return;
  pageNum--;
  queueRenderPage(pageNum);
}
function nextPage() {
  if (pageNum >= pdfDoc.numPages) return;
  pageNum++;
  queueRenderPage(pageNum);
}
function zoomIn(){ scale+=0.1; renderPage(pageNum); }
function zoomOut(){ scale-=0.1; renderPage(pageNum); }

function toggleDark(){
  document.body.style.background =
    (document.body.style.background=='white')?'black':'white';
  document.body.style.color =
    (document.body.style.color=='black')?'white':'black';
}

pdfjsLib.getDocument(pdfUrl).promise.then(function (pdfDoc_) {
  pdfDoc = pdfDoc_;
  document.getElementById('page-count').textContent = pdfDoc.numPages;
  renderPage(pageNum);
});
</script>
</body>
</html>
